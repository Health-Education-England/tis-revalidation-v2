<div
  *ngIf="submitting; else notSubmitting"
  class="d-flex align-content-center justify-content-center align-items-center progress-spinner"
>
  <mat-spinner></mat-spinner>
</div>

<ng-template #notSubmitting>
  <mat-card class="mb-20" appearance="outlined">
    <mat-card-title>Current designated body</mat-card-title>
    <mat-card-content>
      <ng-container *ngIf="doctorCurrentDbc$ | async; else NoDBC">
        {{ doctorCurrentDbc$ | async | formatDesignatedBody: "name" }}
      </ng-container>
      <ng-template #NoDBC> No current connection </ng-template>
    </mat-card-content>
  </mat-card>
  <div
    class="table-container"
    *ngIf="connectionHistory$ | async as connectionHistory"
  >
    <mat-card class="mb-20" appearance="outlined">
      <mat-card-title
        >Connection history - including external GMC updates</mat-card-title
      >
      <table
        mat-table
        [dataSource]="connectionHistory"
        multiTemplateDataRows
        class="w-100"
        data-cy="connection-history-table"
      >
        <caption class="collapsed no-height">
          Trainee historical connection details
        </caption>
        <ng-container matColumnDef="newDesignatedBodyCode">
          <th mat-header-cell scope="col" *matHeaderCellDef>New DBC</th>
          <td mat-cell *matCellDef="let element" data-testid="New DBC">
            {{ element.newDesignatedBodyCode | formatDesignatedBody: "abbr" }}
          </td>
        </ng-container>

        <ng-container matColumnDef="previousDesignatedBodyCode">
          <th mat-header-cell scope="col" *matHeaderCellDef>Old DBC</th>
          <td mat-cell *matCellDef="let element" data-testid="Old DBC">
            {{
              element.previousDesignatedBodyCode | formatDesignatedBody: "abbr"
            }}
          </td>
        </ng-container>

        <ng-container matColumnDef="designatedBodyCode">
          <th mat-header-cell scope="col" *matHeaderCellDef>Designated body</th>
          <td mat-cell *matCellDef="let element" data-testid="Designated body">
            {{ doctorCurrentDbc | formatDesignatedBody: "abbr" }}
          </td>
        </ng-container>

        <ng-container matColumnDef="requestType">
          <th mat-header-cell scope="col" *matHeaderCellDef>Request type</th>
          <td mat-cell *matCellDef="let element" data-testid="Request type">
            {{ element.requestType ? element.requestType : "EXTERNAL" }}
          </td>
        </ng-container>

        <ng-container matColumnDef="reasonMessage">
          <th mat-header-cell scope="col" *matHeaderCellDef>Reason</th>
          <td mat-cell *matCellDef="let element" data-testid="Reason">
            {{ element.reasonMessage }}
          </td>
        </ng-container>

        <ng-container matColumnDef="requestTime">
          <th mat-header-cell scope="col" *matHeaderCellDef>Updated</th>
          <td mat-cell *matCellDef="let element" data-testid="Updated">
            {{ element.requestTime | date: dateFormat }}
          </td>
        </ng-container>

        <ng-container matColumnDef="updatedBy">
          <th mat-header-cell scope="col" *matHeaderCellDef>Updated by</th>
          <td mat-cell *matCellDef="let element" data-testid="Updated by">
            {{ element.updatedBy | AdminName: "username" }}
          </td>
        </ng-container>

        <ng-container matColumnDef="expandedDetail">
          <td
            mat-cell
            *matCellDef="let element"
            [attr.colspan]="connectionsColumnsToDisplay.length"
          >
            <div
              *ngIf="element.responseCode"
              class="element-detail"
              [@detailExpand]="
                element === expandedElement ? 'expanded' : 'collapsed'
              "
            >
              <div class="element-expanded">
                <h3 class="mat-h3">
                  GMC Response:
                  <span>
                    {{ element.responseMessage }}
                  </span>
                </h3>
              </div>
            </div>
          </td>
        </ng-container>

        <tr
          mat-header-row
          *matHeaderRowDef="connectionsColumnsToDisplay"
          [ngClass]="{ hide: connectionHistory?.length === 0 }"
          class="element-row"
        ></tr>
        <tr
          tabindex="0"
          mat-row
          *matRowDef="let element; columns: connectionsColumnsToDisplay"
          class="element-row"
          [class.expanded-row]="expandedElement === element"
          (click)="currentExpanded(element, $event)"
          (keyup.enter)="currentExpanded(element, $event)"
          (keyup.space)="currentExpanded(element, $event)"
          [class.highlight-row-secondary]="!element.responseCode"
          [class.highlight-row-warn]="
            element.responseCode && element.responseCode !== '0'
          "
          [class.highlight-row-success]="element.responseCode === '0'"
        ></tr>
        <tr
          mat-row
          *matRowDef="let row; columns: ['expandedDetail']"
          class="detail-row"
        ></tr>

        <ng-container matColumnDef="noRecord">
          <td colspan="12" mat-footer-cell class="centered" *matFooterCellDef>
            <em class="icon-warn">No history available.</em>
          </td>
        </ng-container>
        <tr
          mat-footer-row
          *matFooterRowDef="['noRecord']"
          class="highlight-row-warn"
          [ngClass]="{ hide: connectionHistory?.length > 0 }"
        ></tr>
      </table>
    </mat-card>
    <app-update-connection
      *ngIf="enableUpdateConnection"
      [currentDoctorDbcCode]="doctorCurrentDbc"
      (submittFormEvent)="updateConnection($event)"
    >
    </app-update-connection>
  </div>
</ng-template>
